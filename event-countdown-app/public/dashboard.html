<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Dashboard</h1>
  <button id="logout-button">Logout</button>
  <button id="create-event-button">Create New Event</button>
  <button id="manage-categories-button">Manage Categories</button>

  <div>
    <label for="category-filter">Filter by Category:</label>
    <select id="category-filter">
      <option value="all">All</option>
      <!-- Dynamically populate category options here -->
    </select>
  </div>

  <div id="events-list">
    <!-- Event items will be inserted here dynamically -->
  </div>

  <form id="countdown-form" style="display: none;">
    <h2>Create Countdown</h2>
    <input type="text" id="title" placeholder="Event Title" required>
    <input type="text" id="description" placeholder="Description">
    <input type="datetime-local" id="date" required>
    <select id="category" required>
      <!-- Dynamically populate category options here -->
    </select>
    <button type="submit">Create</button>
    <button type="button" id="back-to-dashboard">Back to Dashboard</button>
  </form>

  <script>
    const countdownForm = document.getElementById('countdown-form');
    const eventsList = document.getElementById('events-list');
    const backToDashboardButton = document.getElementById('back-to-dashboard');

    async function loadEvents() {
<<<<<<< Updated upstream
  console.log("loadEvents function called"); // Log function call
  const token = localStorage.getItem('token');
  const response = await fetch('/countdowns', {
    headers: {
      'Authorization': `Bearer ${token}`
=======
      const token = localStorage.getItem('token');
      const categoryFilter = document.getElementById('category-filter').value;
      let url = '/countdowns';
      if (categoryFilter !== 'all') {
        url += `?categoryId=${categoryFilter}`;
      }
      console.log('Fetching events from URL:', url);
      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const events = await response.json();
      eventsList.innerHTML = '';
      events.forEach(event => {
        const eventItem = document.createElement('div');
        eventItem.className = 'event-item';
        eventItem.innerHTML = `
          <h3>${event.title}</h3>
          <p>${event.description}</p>
          <p>${new Date(event.date).toLocaleString()}</p>
          <p>Time Remaining: <span id="countdown-${event._id}"></span></p>
          <button onclick="viewEvent('${event._id}')">View</button>
          <button onclick="deleteEvent('${event._id}')">Delete</button>
        `;
        eventsList.appendChild(eventItem);
      });
>>>>>>> Stashed changes
    }
  });
  const events = await response.json();
  console.log("Events received:", events); // Log events received
  eventsList.innerHTML = '';
  events.forEach(event => {
    console.log("Processing event:", event); // Log each event processed
    const eventItem = document.createElement('div');
    eventItem.className = 'event-item';
    eventItem.innerHTML = `
      <h3>${event.title}</h3>
      <p>${event.description}</p>
      <p>${new Date(event.date).toLocaleString()}</p>
      <p>Time Remaining: <span id="countdown-${event._id}"></span></p>
      <div id="notifications-${event._id}"></div>
      <button onclick="viewEvent('${event._id}')">View</button>
      <button onclick="deleteEvent('${event._id}')">Delete</button>
    `;
    eventsList.appendChild(eventItem);
    updateCountdown(event._id, event.date);
    loadNotifications(event._id);
  });
}

<<<<<<< Updated upstream
document.addEventListener('DOMContentLoaded', () => {
  if (!localStorage.getItem('token')) {
    window.location.href = '/index.html';
  } else {
    loadEvents();
  }
});

async function loadNotifications(eventId) {
  console.log(`loadNotifications called for eventId: ${eventId}`); // Log function call
  const token = localStorage.getItem('token');
  const response = await fetch(`/notifications?countdownId=${eventId}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  console.log(`Fetch response status: ${response.status}`); // Log response status
  const notifications = await response.json();
  console.log(`Notifications received: ${JSON.stringify(notifications)}`); // Log received notifications
  const notificationsDiv = document.getElementById(`notifications-${eventId}`);
  notificationsDiv.innerHTML = '<h4>Notifications</h4>';
  notifications.forEach(notification => {
    console.log(notification.time); // Log notification time
    const notificationItem = document.createElement('div');
    notificationItem.className = 'notification-item';
    const notificationTime = new Date(notification.time);
    if (isNaN(notificationTime.getTime())) {
      console.error(`Invalid Date: ${notification.time}`);
      notificationItem.innerHTML = `
        <p>Invalid Date: ${notification.message}</p>
      `;
    } else {
      notificationItem.innerHTML = `
        <p>${notificationTime.toLocaleString()}: ${notification.message}</p>
      `;
    }
    notificationsDiv.appendChild(notificationItem);
  });
}


    function updateCountdown(id, date) {
      const countdownElement = document.getElementById(`countdown-${id}`);
      const eventDate = new Date(date).getTime();
      setInterval(() => {
        const now = new Date().getTime();
        const distance = eventDate - now;
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        countdownElement.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        if (distance < 0) {
          countdownElement.innerHTML = "EXPIRED";
          alert('Event Ended: ' + document.querySelector(`#countdown-${id}`).closest('.event-item').querySelector('h3').textContent);
          deleteEvent(id);
        }
      }, 1000);
    }

=======
>>>>>>> Stashed changes
    function showDashboard() {
      countdownForm.style.display = 'none';
      eventsList.style.display = 'block';
      loadEvents();
      loadCategories();
    }

    function showForm(form) {
      eventsList.style.display = 'none';
      countdownForm.style.display = 'none';
      form.style.display = 'block';
    }

    document.getElementById('logout-button').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = '/index.html';
    });

    document.getElementById('create-event-button').addEventListener('click', () => {
      showForm(countdownForm);
    });

    document.getElementById('manage-categories-button').addEventListener('click', () => {
      window.location.href = '/category.html';
    });

    countdownForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const date = document.getElementById('date').value;
      const categoryId = document.getElementById('category').value;
      const token = localStorage.getItem('token');
      const response = await fetch('/countdowns', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ title, description, date, categoryId })
      });
      const data = await response.json();
      if (data.title) {
        alert('Countdown created successfully');
        showDashboard();
      } else {
        alert('Failed to create countdown');
      }
    });

    backToDashboardButton.addEventListener('click', () => {
      showDashboard();
    });

<<<<<<< Updated upstream
    cancelUpdateButton.addEventListener('click', () => {
      showDashboard();
    });

    async function editEvent(id, title, description, date) {
  window.location.href = `/event.html?id=${id}`;
}
    async function loadUpdateNotifications(eventId) {
      const token = localStorage.getItem('token');
      const response = await fetch(`/notifications?countdownId=${eventId}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const notifications = await response.json();
      const updateRemindersList = document.getElementById('update-reminders-list');
      updateRemindersList.innerHTML = '';
      notifications.forEach(notification => {
        const notificationItem = document.createElement('div');
        notificationItem.className = 'reminder-item';
        notificationItem.innerHTML = `
          <input type="text" class="reminder-message" value="${notification.message}" required>
          <input type="datetime-local" class="reminder-time" value="${new Date(notification.time).toISOString().slice(0, 16)}" required>
          <button type="button" class="remove-reminder-button">Remove</button>
        `;
        updateRemindersList.appendChild(notificationItem);

        notificationItem.querySelector('.remove-reminder-button').addEventListener('click', () => {
          notificationItem.remove();
        });
      });
    }

=======
>>>>>>> Stashed changes
    async function deleteEvent(id) {
  if (!confirm('Are you sure you want to delete this event?')) {
    return;
  }
  const token = localStorage.getItem('token');
  const response = await fetch(`/countdowns/${id}`, {
    method: 'DELETE',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  const data = await response.json();
  if (data._id) {
    alert('Countdown deleted successfully');
    showDashboard();
  } else {
    alert('Failed to delete countdown');
  }
}

    function viewEvent(id) {
      window.location.href = `/event.html?id=${id}`;
    }

    async function loadCategories() {
      const token = localStorage.getItem('token');
      const response = await fetch('/categories', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const categories = await response.json();
      const categoryFilter = document.getElementById('category-filter');
      const categorySelect = document.getElementById('category');
      categoryFilter.innerHTML = '<option value="all">All</option>';
      categorySelect.innerHTML = '';
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category._id;
        option.textContent = category.name;
        categoryFilter.appendChild(option);

        const optionClone = option.cloneNode(true);
        categorySelect.appendChild(optionClone);
      });
    }

    document.getElementById('category-filter').addEventListener('change', loadEvents);

    if (!localStorage.getItem('token')) {
      window.location.href = '/index.html';
    } else {
      loadCategories();
      showDashboard();
    }
    
  </script>
</body>
</html>
